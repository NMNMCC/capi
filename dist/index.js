#!/usr/bin/env node
import './sourcemap-register.cjs';var e={334:(e,t)=>{
/**
 * @otplib/core
 *
 * @author Gerald Yeo <contact@fusedthought.com>
 * @version: 12.0.1
 * @license: MIT
 **/
Object.defineProperty(t,"__esModule",{value:true});function objectValues(e){return Object.keys(e).map((t=>e[t]))}(function(e){e["SHA1"]="sha1";e["SHA256"]="sha256";e["SHA512"]="sha512"})(t.HashAlgorithms||(t.HashAlgorithms={}));const r=objectValues(t.HashAlgorithms);(function(e){e["ASCII"]="ascii";e["BASE64"]="base64";e["HEX"]="hex";e["LATIN1"]="latin1";e["UTF8"]="utf8"})(t.KeyEncodings||(t.KeyEncodings={}));const n=objectValues(t.KeyEncodings);(function(e){e["HOTP"]="hotp";e["TOTP"]="totp"})(t.Strategy||(t.Strategy={}));const o=objectValues(t.Strategy);const createDigestPlaceholder=()=>{throw new Error("Please provide an options.createDigest implementation.")};function isTokenValid(e){return/^(\d+)$/.test(e)}function padStart(e,t,r){if(e.length>=t){return e}const n=Array(t+1).join(r);return`${n}${e}`.slice(-1*t)}function keyuri(e){const t=`otpauth://${e.type}/{labelPrefix}:{accountName}?secret={secret}{query}`;const r=[];if(o.indexOf(e.type)<0){throw new Error(`Expecting options.type to be one of ${o.join(", ")}. Received ${e.type}.`)}if(e.type==="hotp"){if(e.counter==null||typeof e.counter!=="number"){throw new Error('Expecting options.counter to be a number when options.type is "hotp".')}r.push(`&counter=${e.counter}`)}if(e.type==="totp"&&e.step){r.push(`&period=${e.step}`)}if(e.digits){r.push(`&digits=${e.digits}`)}if(e.algorithm){r.push(`&algorithm=${e.algorithm.toUpperCase()}`)}if(e.issuer){r.push(`&issuer=${encodeURIComponent(e.issuer)}`)}return t.replace("{labelPrefix}",encodeURIComponent(e.issuer||e.accountName)).replace("{accountName}",encodeURIComponent(e.accountName)).replace("{secret}",e.secret).replace("{query}",r.join(""))}class OTP{constructor(e={}){this._defaultOptions=Object.freeze({...e});this._options=Object.freeze({})}create(e={}){return new OTP(e)}clone(e={}){const t=this.create({...this._defaultOptions,...e});t.options=this._options;return t}get options(){return Object.freeze({...this._defaultOptions,...this._options})}set options(e){this._options=Object.freeze({...this._options,...e})}allOptions(){return this.options}resetOptions(){this._options=Object.freeze({})}}function hotpOptionsValidator(e){if(typeof e.createDigest!=="function"){throw new Error("Expecting options.createDigest to be a function.")}if(typeof e.createHmacKey!=="function"){throw new Error("Expecting options.createHmacKey to be a function.")}if(typeof e.digits!=="number"){throw new Error("Expecting options.digits to be a number.")}if(!e.algorithm||r.indexOf(e.algorithm)<0){throw new Error(`Expecting options.algorithm to be one of ${r.join(", ")}. Received ${e.algorithm}.`)}if(!e.encoding||n.indexOf(e.encoding)<0){throw new Error(`Expecting options.encoding to be one of ${n.join(", ")}. Received ${e.encoding}.`)}}const hotpCreateHmacKey=(e,t,r)=>Buffer.from(t,r).toString("hex");function hotpDefaultOptions(){const e={algorithm:t.HashAlgorithms.SHA1,createHmacKey:hotpCreateHmacKey,createDigest:createDigestPlaceholder,digits:6,encoding:t.KeyEncodings.ASCII};return e}function hotpOptions(e){const t={...hotpDefaultOptions(),...e};hotpOptionsValidator(t);return Object.freeze(t)}function hotpCounter(e){const t=e.toString(16);return padStart(t,16,"0")}function hotpDigestToToken(e,t){const r=Buffer.from(e,"hex");const n=r[r.length-1]&15;const o=(r[n]&127)<<24|(r[n+1]&255)<<16|(r[n+2]&255)<<8|r[n+3]&255;const s=o%Math.pow(10,t);return padStart(String(s),t,"0")}function hotpDigest(e,t,r){const n=hotpCounter(t);const o=r.createHmacKey(r.algorithm,e,r.encoding);return r.createDigest(r.algorithm,o,n)}function hotpToken(e,t,r){const n=r.digest||hotpDigest(e,t,r);return hotpDigestToToken(n,r.digits)}function hotpCheck(e,t,r,n){if(!isTokenValid(e)){return false}const o=hotpToken(t,r,n);return e===o}function hotpKeyuri(e,r,n,o,s){return keyuri({algorithm:s.algorithm,digits:s.digits,type:t.Strategy.HOTP,accountName:e,counter:o,issuer:r,secret:n})}class HOTP extends OTP{create(e={}){return new HOTP(e)}allOptions(){return hotpOptions(this.options)}generate(e,t){return hotpToken(e,t,this.allOptions())}check(e,t,r){return hotpCheck(e,t,r,this.allOptions())}verify(e){if(typeof e!=="object"){throw new Error("Expecting argument 0 of verify to be an object")}return this.check(e.token,e.secret,e.counter)}keyuri(e,t,r,n){return hotpKeyuri(e,t,r,n,this.allOptions())}}function parseWindowBounds(e){if(typeof e==="number"){return[Math.abs(e),Math.abs(e)]}if(Array.isArray(e)){const[t,r]=e;if(typeof t==="number"&&typeof r==="number"){return[Math.abs(t),Math.abs(r)]}}throw new Error("Expecting options.window to be an number or [number, number].")}function totpOptionsValidator(e){hotpOptionsValidator(e);parseWindowBounds(e.window);if(typeof e.epoch!=="number"){throw new Error("Expecting options.epoch to be a number.")}if(typeof e.step!=="number"){throw new Error("Expecting options.step to be a number.")}}const totpPadSecret=(e,t,r)=>{const n=e.length;const o=Buffer.from(e,t).toString("hex");if(n<r){const e=new Array(r-n+1).join(o);return Buffer.from(e,"hex").slice(0,r).toString("hex")}return o};const totpCreateHmacKey=(e,n,o)=>{switch(e){case t.HashAlgorithms.SHA1:return totpPadSecret(n,o,20);case t.HashAlgorithms.SHA256:return totpPadSecret(n,o,32);case t.HashAlgorithms.SHA512:return totpPadSecret(n,o,64);default:throw new Error(`Expecting algorithm to be one of ${r.join(", ")}. Received ${e}.`)}};function totpDefaultOptions(){const e={algorithm:t.HashAlgorithms.SHA1,createDigest:createDigestPlaceholder,createHmacKey:totpCreateHmacKey,digits:6,encoding:t.KeyEncodings.ASCII,epoch:Date.now(),step:30,window:0};return e}function totpOptions(e){const t={...totpDefaultOptions(),...e};totpOptionsValidator(t);return Object.freeze(t)}function totpCounter(e,t){return Math.floor(e/t/1e3)}function totpToken(e,t){const r=totpCounter(t.epoch,t.step);return hotpToken(e,r,t)}function totpEpochsInWindow(e,t,r,n){const o=[];if(n===0){return o}for(let s=1;s<=n;s++){const n=t*s*r;o.push(e+n)}return o}function totpEpochAvailable(e,t,r){const n=parseWindowBounds(r);const o=t*1e3;return{current:e,past:totpEpochsInWindow(e,-1,o,n[0]),future:totpEpochsInWindow(e,1,o,n[1])}}function totpCheck(e,t,r){if(!isTokenValid(e)){return false}const n=totpToken(t,r);return e===n}function totpCheckByEpoch(e,t,r,n){let o=null;e.some(((e,s)=>{if(totpCheck(t,r,{...n,epoch:e})){o=s+1;return true}return false}));return o}function totpCheckWithWindow(e,t,r){if(totpCheck(e,t,r)){return 0}const n=totpEpochAvailable(r.epoch,r.step,r.window);const o=totpCheckByEpoch(n.past,e,t,r);if(o!==null){return o*-1}return totpCheckByEpoch(n.future,e,t,r)}function totpTimeUsed(e,t){return Math.floor(e/1e3)%t}function totpTimeRemaining(e,t){return t-totpTimeUsed(e,t)}function totpKeyuri(e,r,n,o){return keyuri({algorithm:o.algorithm,digits:o.digits,step:o.step,type:t.Strategy.TOTP,accountName:e,issuer:r,secret:n})}class TOTP extends HOTP{create(e={}){return new TOTP(e)}allOptions(){return totpOptions(this.options)}generate(e){return totpToken(e,this.allOptions())}checkDelta(e,t){return totpCheckWithWindow(e,t,this.allOptions())}check(e,t){const r=this.checkDelta(e,t);return typeof r==="number"}verify(e){if(typeof e!=="object"){throw new Error("Expecting argument 0 of verify to be an object")}return this.check(e.token,e.secret)}timeRemaining(){const e=this.allOptions();return totpTimeRemaining(e.epoch,e.step)}timeUsed(){const e=this.allOptions();return totpTimeUsed(e.epoch,e.step)}keyuri(e,t,r){return totpKeyuri(e,t,r,this.allOptions())}}function authenticatorOptionValidator(e){totpOptionsValidator(e);if(typeof e.keyDecoder!=="function"){throw new Error("Expecting options.keyDecoder to be a function.")}if(e.keyEncoder&&typeof e.keyEncoder!=="function"){throw new Error("Expecting options.keyEncoder to be a function.")}}function authenticatorDefaultOptions(){const e={algorithm:t.HashAlgorithms.SHA1,createDigest:createDigestPlaceholder,createHmacKey:totpCreateHmacKey,digits:6,encoding:t.KeyEncodings.HEX,epoch:Date.now(),step:30,window:0};return e}function authenticatorOptions(e){const t={...authenticatorDefaultOptions(),...e};authenticatorOptionValidator(t);return Object.freeze(t)}function authenticatorEncoder(e,t){return t.keyEncoder(e,t.encoding)}function authenticatorDecoder(e,t){return t.keyDecoder(e,t.encoding)}function authenticatorGenerateSecret(e,t){const r=t.createRandomBytes(e,t.encoding);return authenticatorEncoder(r,t)}function authenticatorToken(e,t){return totpToken(authenticatorDecoder(e,t),t)}function authenticatorCheckWithWindow(e,t,r){return totpCheckWithWindow(e,authenticatorDecoder(t,r),r)}class Authenticator extends TOTP{create(e={}){return new Authenticator(e)}allOptions(){return authenticatorOptions(this.options)}generate(e){return authenticatorToken(e,this.allOptions())}checkDelta(e,t){return authenticatorCheckWithWindow(e,t,this.allOptions())}encode(e){return authenticatorEncoder(e,this.allOptions())}decode(e){return authenticatorDecoder(e,this.allOptions())}generateSecret(e=10){return authenticatorGenerateSecret(e,this.allOptions())}}t.Authenticator=Authenticator;t.HASH_ALGORITHMS=r;t.HOTP=HOTP;t.KEY_ENCODINGS=n;t.OTP=OTP;t.STRATEGY=o;t.TOTP=TOTP;t.authenticatorCheckWithWindow=authenticatorCheckWithWindow;t.authenticatorDecoder=authenticatorDecoder;t.authenticatorDefaultOptions=authenticatorDefaultOptions;t.authenticatorEncoder=authenticatorEncoder;t.authenticatorGenerateSecret=authenticatorGenerateSecret;t.authenticatorOptionValidator=authenticatorOptionValidator;t.authenticatorOptions=authenticatorOptions;t.authenticatorToken=authenticatorToken;t.createDigestPlaceholder=createDigestPlaceholder;t.hotpCheck=hotpCheck;t.hotpCounter=hotpCounter;t.hotpCreateHmacKey=hotpCreateHmacKey;t.hotpDefaultOptions=hotpDefaultOptions;t.hotpDigestToToken=hotpDigestToToken;t.hotpKeyuri=hotpKeyuri;t.hotpOptions=hotpOptions;t.hotpOptionsValidator=hotpOptionsValidator;t.hotpToken=hotpToken;t.isTokenValid=isTokenValid;t.keyuri=keyuri;t.objectValues=objectValues;t.padStart=padStart;t.totpCheck=totpCheck;t.totpCheckByEpoch=totpCheckByEpoch;t.totpCheckWithWindow=totpCheckWithWindow;t.totpCounter=totpCounter;t.totpCreateHmacKey=totpCreateHmacKey;t.totpDefaultOptions=totpDefaultOptions;t.totpEpochAvailable=totpEpochAvailable;t.totpKeyuri=totpKeyuri;t.totpOptions=totpOptions;t.totpOptionsValidator=totpOptionsValidator;t.totpPadSecret=totpPadSecret;t.totpTimeRemaining=totpTimeRemaining;t.totpTimeUsed=totpTimeUsed;t.totpToken=totpToken},438:(e,t,r)=>{
/**
 * @otplib/plugin-crypto
 *
 * @author Gerald Yeo <contact@fusedthought.com>
 * @version: 12.0.1
 * @license: MIT
 **/
Object.defineProperty(t,"__esModule",{value:true});function _interopDefault(e){return e&&typeof e==="object"&&"default"in e?e["default"]:e}var n=_interopDefault(r(982));const createDigest=(e,t,r)=>{const o=n.createHmac(e,Buffer.from(t,"hex"));const s=o.update(Buffer.from(r,"hex")).digest();return s.toString("hex")};const createRandomBytes=(e,t)=>n.randomBytes(e).toString(t);t.createDigest=createDigest;t.createRandomBytes=createRandomBytes},266:(e,t,r)=>{
/**
 * @otplib/plugin-thirty-two
 *
 * @author Gerald Yeo <contact@fusedthought.com>
 * @version: 12.0.1
 * @license: MIT
 **/
Object.defineProperty(t,"__esModule",{value:true});function _interopDefault(e){return e&&typeof e==="object"&&"default"in e?e["default"]:e}var n=_interopDefault(r(263));const keyDecoder=(e,t)=>n.decode(e).toString(t);const keyEncoder=(e,t)=>n.encode(Buffer.from(e,t).toString("ascii")).toString().replace(/=/g,"");t.keyDecoder=keyDecoder;t.keyEncoder=keyEncoder},766:(e,t,r)=>{
/**
 * @otplib/preset-default
 *
 * @author Gerald Yeo <contact@fusedthought.com>
 * @version: 12.0.1
 * @license: MIT
 **/
Object.defineProperty(t,"__esModule",{value:true});var n=r(438);var o=r(266);var s=r(334);const i=new s.HOTP({createDigest:n.createDigest});const a=new s.TOTP({createDigest:n.createDigest});const c=new s.Authenticator({createDigest:n.createDigest,createRandomBytes:n.createRandomBytes,keyDecoder:o.keyDecoder,keyEncoder:o.keyEncoder});t.authenticator=c;t.hotp=i;t.totp=a},882:(e,t,r)=>{
/**
 * otplib
 *
 * @author Gerald Yeo <contact@fusedthought.com>
 * @version: 12.0.1
 * @license: MIT
 **/
Object.defineProperty(t,"__esModule",{value:true});var n=r(766);Object.keys(n).forEach((function(e){if(e!=="default")Object.defineProperty(t,e,{enumerable:true,get:function(){return n[e]}})}))},263:(e,t,r)=>{var n=r(368);t.encode=n.encode;t.decode=n.decode},368:(e,t)=>{var r="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";var n=[255,255,26,27,28,29,30,31,255,255,255,255,255,255,255,255,255,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,255,255,255,255,255,255,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,255,255,255,255,255];function quintetCount(e){var t=Math.floor(e.length/5);return e.length%5===0?t:t+1}t.encode=function(e){if(!Buffer.isBuffer(e)){e=new Buffer(e)}var t=0;var n=0;var o=0;var s=0;var i=new Buffer(quintetCount(e)*8);while(t<e.length){var a=e[t];if(o>3){s=a&255>>o;o=(o+5)%8;s=s<<o|(t+1<e.length?e[t+1]:0)>>8-o;t++}else{s=a>>8-(o+5)&31;o=(o+5)%8;if(o===0)t++}i[n]=r.charCodeAt(s);n++}for(t=n;t<i.length;t++){i[t]=61}return i};t.decode=function(e){var t=0;var r=0;var o;var s=0;if(!Buffer.isBuffer(e)){e=new Buffer(e)}var i=new Buffer(Math.ceil(e.length*5/8));for(var a=0;a<e.length;a++){if(e[a]===61){break}var c=e[a]-48;if(c<n.length){r=n[c];if(t<=3){t=(t+5)%8;if(t===0){o|=r;i[s]=o;s++;o=0}else{o|=255&r<<8-t}}else{t=(t+5)%8;o|=255&r>>>t;i[s]=o;s++;o=255&r<<8-t}}else{throw new Error("Invalid input - it is not base32 encoded string")}}return i.slice(0,s)}},982:e=>{e.exports=require("crypto")}};var t={};function __nccwpck_require__(r){var n=t[r];if(n!==undefined){return n.exports}var o=t[r]={exports:{}};var s=true;try{e[r](o,o.exports,__nccwpck_require__);s=false}finally{if(s)delete t[r]}return o.exports}if(typeof __nccwpck_require__!=="undefined")__nccwpck_require__.ab=new URL(".",import.meta.url).pathname.slice(import.meta.url.match(/^file:\/\/\/\w:/)?1:0,-1)+"/";var r={};const n=require("http");const o=require("http2");const s=require("stream");var i=__nccwpck_require__(982);var a=class extends Error{static name="RequestError";constructor(e,t){super(e,t)}};var toRequestError=e=>{if(e instanceof a){return e}return new a(e.message,{cause:e})};var c=global.Request;var h=class extends c{constructor(e,t){if(typeof e==="object"&&u in e){e=e[u]()}if(typeof t?.body?.getReader!=="undefined"){t.duplex??="half"}super(e,t)}};var newRequestFromIncoming=(e,t,r,n)=>{const o=[];const i=r.rawHeaders;for(let e=0;e<i.length;e+=2){const{[e]:t,[e+1]:r}=i;if(t.charCodeAt(0)!==58){o.push([t,r])}}const a={method:e,headers:o,signal:n.signal};if(e==="TRACE"){a.method="GET";const e=new h(t,a);Object.defineProperty(e,"method",{get(){return"TRACE"}});return e}if(!(e==="GET"||e==="HEAD")){if("rawBody"in r&&r.rawBody instanceof Buffer){a.body=new ReadableStream({start(e){e.enqueue(r.rawBody);e.close()}})}else{a.body=s.Readable.toWeb(r)}}return new h(t,a)};var u=Symbol("getRequestCache");var l=Symbol("requestCache");var d=Symbol("incomingKey");var f=Symbol("urlKey");var p=Symbol("abortControllerKey");var g=Symbol("getAbortController");var y={get method(){return this[d].method||"GET"},get url(){return this[f]},[g](){this[u]();return this[p]},[u](){this[p]||=new AbortController;return this[l]||=newRequestFromIncoming(this.method,this[f],this[d],this[p])}};["body","bodyUsed","cache","credentials","destination","headers","integrity","mode","redirect","referrer","referrerPolicy","signal","keepalive"].forEach((e=>{Object.defineProperty(y,e,{get(){return this[u]()[e]}})}));["arrayBuffer","blob","clone","formData","json","text"].forEach((e=>{Object.defineProperty(y,e,{value:function(){return this[u]()[e]()}})}));Object.setPrototypeOf(y,h.prototype);var newRequest=(e,t)=>{const r=Object.create(y);r[d]=e;const n=e.url||"";if(n[0]!=="/"&&(n.startsWith("http://")||n.startsWith("https://"))){if(e instanceof o.Http2ServerRequest){throw new a("Absolute URL for :path is not allowed in HTTP/2")}try{const e=new URL(n);r[f]=e.href}catch(e){throw new a("Invalid absolute URL",{cause:e})}return r}const s=(e instanceof o.Http2ServerRequest?e.authority:e.headers.host)||t;if(!s){throw new a("Missing host header")}let i;if(e instanceof o.Http2ServerRequest){i=e.scheme;if(!(i==="http"||i==="https")){throw new a("Unsupported scheme")}}else{i=e.socket&&e.socket.encrypted?"https":"http"}const c=new URL(`${i}://${s}${n}`);if(c.hostname.length!==s.length&&c.hostname!==s.replace(/:\d+$/,"")){throw new a("Invalid host header")}r[f]=c.href;return r};function writeFromReadableStream(e,t){if(e.locked){throw new TypeError("ReadableStream is locked.")}else if(t.destroyed){e.cancel();return}const r=e.getReader();t.on("close",cancel);t.on("error",cancel);r.read().then(flow,cancel);return r.closed.finally((()=>{t.off("close",cancel);t.off("error",cancel)}));function cancel(e){r.cancel(e).catch((()=>{}));if(e){t.destroy(e)}}function onDrain(){r.read().then(flow,cancel)}function flow({done:e,value:n}){try{if(e){t.end()}else if(!t.write(n)){t.once("drain",onDrain)}else{return r.read().then(flow,cancel)}}catch(e){cancel(e)}}}var buildOutgoingHttpHeaders=e=>{const t={};if(!(e instanceof Headers)){e=new Headers(e??void 0)}const r=[];for(const[n,o]of e){if(n==="set-cookie"){r.push(o)}else{t[n]=o}}if(r.length>0){t["set-cookie"]=r}t["content-type"]??="text/plain; charset=UTF-8";return t};var w=Symbol("responseCache");var m=Symbol("getResponseCache");var b=Symbol("cache");var v=global.Response;var O=class _Response{#e;#t;[m](){delete this[b];return this[w]||=new v(this.#e,this.#t)}constructor(e,t){this.#e=e;if(t instanceof _Response){const e=t[w];if(e){this.#t=e;this[m]();return}else{this.#t=t.#t}}else{this.#t=t}if(typeof e==="string"||typeof e?.getReader!=="undefined"){let r=t?.headers||{"content-type":"text/plain; charset=UTF-8"};if(r instanceof Headers){r=buildOutgoingHttpHeaders(r)}this[b]=[t?.status||200,e,r]}}};["body","bodyUsed","headers","ok","redirected","status","statusText","trailers","type","url"].forEach((e=>{Object.defineProperty(O.prototype,e,{get(){return this[m]()[e]}})}));["arrayBuffer","blob","clone","formData","json","text"].forEach((e=>{Object.defineProperty(O.prototype,e,{value:function(){return this[m]()[e]()}})}));Object.setPrototypeOf(O,v);Object.setPrototypeOf(O.prototype,v.prototype);var E=Reflect.ownKeys(new v).find((e=>typeof e==="symbol"&&e.toString()==="Symbol(state)"));if(!E){console.warn("Failed to find Response internal state key")}function getInternalBody(e){if(!E){return}if(e instanceof O){e=e[m]()}const t=e[E];return t&&t.body||void 0}var x="x-hono-already-sent";var R=global.fetch;if(typeof global.crypto==="undefined"){global.crypto=i}global.fetch=(e,t)=>{t={compress:false,...t};return R(e,t)};var k=/^no$/i;var T=/^(application\/json\b|text\/(?!event-stream\b))/i;var handleRequestError=()=>new Response(null,{status:400});var handleFetchError=e=>new Response(null,{status:e instanceof Error&&(e.name==="TimeoutError"||e.constructor.name==="TimeoutError")?504:500});var handleResponseError=(e,t)=>{const r=e instanceof Error?e:new Error("unknown error",{cause:e});if(r.code==="ERR_STREAM_PREMATURE_CLOSE"){console.info("The user aborted a request.")}else{console.error(e);if(!t.headersSent){t.writeHead(500,{"Content-Type":"text/plain"})}t.end(`Error: ${r.message}`);t.destroy(r)}};var responseViaCache=(e,t)=>{const[r,n,o]=e[b];if(typeof n==="string"){o["Content-Length"]=Buffer.byteLength(n);t.writeHead(r,o);t.end(n)}else{t.writeHead(r,o);return writeFromReadableStream(n,t)?.catch((e=>handleResponseError(e,t)))}};var responseViaResponseObject=async(e,t,r={})=>{if(e instanceof Promise){if(r.errorHandler){try{e=await e}catch(t){const n=await r.errorHandler(t);if(!n){return}e=n}}else{e=await e.catch(handleFetchError)}}if(b in e){return responseViaCache(e,t)}const n=buildOutgoingHttpHeaders(e.headers);const o=getInternalBody(e);if(o){const{length:r,source:s,stream:i}=o;if(s instanceof Uint8Array&&s.byteLength!==r){}else{if(r){n["content-length"]=r}t.writeHead(e.status,n);if(typeof s==="string"||s instanceof Uint8Array){t.end(s)}else if(s instanceof Blob){t.end(new Uint8Array(await s.arrayBuffer()))}else{await writeFromReadableStream(i,t)}return}}if(e.body){const{"transfer-encoding":r,"content-encoding":o,"content-length":s,"x-accel-buffering":i,"content-type":a}=n;if(r||o||s||i&&k.test(i)||!T.test(a)){t.writeHead(e.status,n);await writeFromReadableStream(e.body,t)}else{const r=await e.arrayBuffer();n["content-length"]=r.byteLength;t.writeHead(e.status,n);t.end(new Uint8Array(r))}}else if(n[x]){}else{t.writeHead(e.status,n);t.end()}};var getRequestListener=(e,t={})=>{if(t.overrideGlobalObjects!==false&&global.Request!==h){Object.defineProperty(global,"Request",{value:h});Object.defineProperty(global,"Response",{value:O})}return async(r,n)=>{let o,s;try{s=newRequest(r,t.hostname);n.on("close",(()=>{const e=s[p];if(!e){return}if(r.errored){s[p].abort(r.errored.toString())}else if(!n.writableFinished){s[p].abort("Client connection prematurely closed.")}}));o=e(s,{incoming:r,outgoing:n});if(b in o){return responseViaCache(o,n)}}catch(e){if(!o){if(t.errorHandler){o=await t.errorHandler(s?e:toRequestError(e));if(!o){return}}else if(!s){o=handleRequestError()}else{o=handleFetchError(e)}}else{return handleResponseError(e,n)}}try{return responseViaResponseObject(o,n,t)}catch(e){return handleResponseError(e,n)}}};var createAdaptorServer=e=>{const t=e.fetch;const r=getRequestListener(t,{hostname:e.hostname,overrideGlobalObjects:e.overrideGlobalObjects});const o=e.createServer||n.createServer;const s=o(e.serverOptions||{},r);return s};var serve=(e,t)=>{const r=createAdaptorServer(e);r.listen(e?.port??3e3,e.hostname,(()=>{const e=r.address();t&&t(e)}));return r};var compose=(e,t,r)=>(n,o)=>{let s=-1;return dispatch(0);async function dispatch(i){if(i<=s){throw new Error("next() called multiple times")}s=i;let a;let c=false;let h;if(e[i]){h=e[i][0][0];n.req.routeIndex=i}else{h=i===e.length&&o||void 0}if(h){try{a=await h(n,(()=>dispatch(i+1)))}catch(e){if(e instanceof Error&&t){n.error=e;a=await t(e,n);c=true}else{throw e}}}else{if(n.finalized===false&&r){a=await r(n)}}if(a&&(n.finalized===false||c)){n.res=a}return n}};var parseBody=async(e,t=Object.create(null))=>{const{all:r=false,dot:n=false}=t;const o=e instanceof C?e.raw.headers:e.headers;const s=o.get("Content-Type");if(s?.startsWith("multipart/form-data")||s?.startsWith("application/x-www-form-urlencoded")){return parseFormData(e,{all:r,dot:n})}return{}};async function parseFormData(e,t){const r=await e.formData();if(r){return convertFormDataToBodyData(r,t)}return{}}function convertFormDataToBodyData(e,t){const r=Object.create(null);e.forEach(((e,n)=>{const o=t.all||n.endsWith("[]");if(!o){r[n]=e}else{handleParsingAllValues(r,n,e)}}));if(t.dot){Object.entries(r).forEach((([e,t])=>{const n=e.includes(".");if(n){handleParsingNestedValues(r,e,t);delete r[e]}}))}return r}var handleParsingAllValues=(e,t,r)=>{if(e[t]!==void 0){if(Array.isArray(e[t])){e[t].push(r)}else{e[t]=[e[t],r]}}else{e[t]=r}};var handleParsingNestedValues=(e,t,r)=>{let n=e;const o=t.split(".");o.forEach(((e,t)=>{if(t===o.length-1){n[e]=r}else{if(!n[e]||typeof n[e]!=="object"||Array.isArray(n[e])||n[e]instanceof File){n[e]=Object.create(null)}n=n[e]}}))};var splitPath=e=>{const t=e.split("/");if(t[0]===""){t.shift()}return t};var splitRoutingPath=e=>{const{groups:t,path:r}=extractGroupsFromPath(e);const n=splitPath(r);return replaceGroupMarks(n,t)};var extractGroupsFromPath=e=>{const t=[];e=e.replace(/\{[^}]+\}/g,((e,r)=>{const n=`@${r}`;t.push([n,e]);return n}));return{groups:t,path:e}};var replaceGroupMarks=(e,t)=>{for(let r=t.length-1;r>=0;r--){const[n]=t[r];for(let o=e.length-1;o>=0;o--){if(e[o].includes(n)){e[o]=e[o].replace(n,t[r][1]);break}}}return e};var S={};var getPattern=(e,t)=>{if(e==="*"){return"*"}const r=e.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);if(r){const n=`${e}#${t}`;if(!S[n]){if(r[2]){S[n]=t&&t[0]!==":"&&t[0]!=="*"?[n,r[1],new RegExp(`^${r[2]}(?=/${t})`)]:[e,r[1],new RegExp(`^${r[2]}$`)]}else{S[n]=[e,r[1],true]}}return S[n]}return null};var tryDecode=(e,t)=>{try{return t(e)}catch{return e.replace(/(?:%[0-9A-Fa-f]{2})+/g,(e=>{try{return t(e)}catch{return e}}))}};var tryDecodeURI=e=>tryDecode(e,decodeURI);var getPath=e=>{const t=e.url;const r=t.indexOf("/",8);let n=r;for(;n<t.length;n++){const e=t.charCodeAt(n);if(e===37){const e=t.indexOf("?",n);const o=t.slice(r,e===-1?void 0:e);return tryDecodeURI(o.includes("%25")?o.replace(/%25/g,"%2525"):o)}else if(e===63){break}}return t.slice(r,n)};var getQueryStrings=e=>{const t=e.indexOf("?",8);return t===-1?"":"?"+e.slice(t+1)};var getPathNoStrict=e=>{const t=getPath(e);return t.length>1&&t.at(-1)==="/"?t.slice(0,-1):t};var mergePath=(e,t,...r)=>{if(r.length){t=mergePath(t,...r)}return`${e?.[0]==="/"?"":"/"}${e}${t==="/"?"":`${e?.at(-1)==="/"?"":"/"}${t?.[0]==="/"?t.slice(1):t}`}`};var checkOptionalParameter=e=>{if(e.charCodeAt(e.length-1)!==63||!e.includes(":")){return null}const t=e.split("/");const r=[];let n="";t.forEach((e=>{if(e!==""&&!/\:/.test(e)){n+="/"+e}else if(/\:/.test(e)){if(/\?/.test(e)){if(r.length===0&&n===""){r.push("/")}else{r.push(n)}const t=e.replace("?","");n+="/"+t;r.push(n)}else{n+="/"+e}}}));return r.filter(((e,t,r)=>r.indexOf(e)===t))};var _decodeURI=e=>{if(!/[%+]/.test(e)){return e}if(e.indexOf("+")!==-1){e=e.replace(/\+/g," ")}return e.indexOf("%")!==-1?H(e):e};var _getQueryParam=(e,t,r)=>{let n;if(!r&&t&&!/[%+]/.test(t)){let r=e.indexOf(`?${t}`,8);if(r===-1){r=e.indexOf(`&${t}`,8)}while(r!==-1){const n=e.charCodeAt(r+t.length+1);if(n===61){const n=r+t.length+2;const o=e.indexOf("&",n);return _decodeURI(e.slice(n,o===-1?void 0:o))}else if(n==38||isNaN(n)){return""}r=e.indexOf(`&${t}`,r+1)}n=/[%+]/.test(e);if(!n){return void 0}}const o={};n??=/[%+]/.test(e);let s=e.indexOf("?",8);while(s!==-1){const t=e.indexOf("&",s+1);let i=e.indexOf("=",s);if(i>t&&t!==-1){i=-1}let a=e.slice(s+1,i===-1?t===-1?void 0:t:i);if(n){a=_decodeURI(a)}s=t;if(a===""){continue}let c;if(i===-1){c=""}else{c=e.slice(i+1,t===-1?void 0:t);if(n){c=_decodeURI(c)}}if(r){if(!(o[a]&&Array.isArray(o[a]))){o[a]=[]}o[a].push(c)}else{o[a]??=c}}return t?o[t]:o};var j=_getQueryParam;var getQueryParams=(e,t)=>_getQueryParam(e,t,true);var H=decodeURIComponent;var tryDecodeURIComponent=e=>tryDecode(e,H);var C=class{raw;#r;#n;routeIndex=0;path;bodyCache={};constructor(e,t="/",r=[[]]){this.raw=e;this.path=t;this.#n=r;this.#r={}}param(e){return e?this.#o(e):this.#s()}#o(e){const t=this.#n[0][this.routeIndex][1][e];const r=this.#i(t);return r?/\%/.test(r)?tryDecodeURIComponent(r):r:void 0}#s(){const e={};const t=Object.keys(this.#n[0][this.routeIndex][1]);for(const r of t){const t=this.#i(this.#n[0][this.routeIndex][1][r]);if(t&&typeof t==="string"){e[r]=/\%/.test(t)?tryDecodeURIComponent(t):t}}return e}#i(e){return this.#n[1]?this.#n[1][e]:e}query(e){return j(this.url,e)}queries(e){return getQueryParams(this.url,e)}header(e){if(e){return this.raw.headers.get(e)??void 0}const t={};this.raw.headers.forEach(((e,r)=>{t[r]=e}));return t}async parseBody(e){return this.bodyCache.parsedBody??=await parseBody(this,e)}#a=e=>{const{bodyCache:t,raw:r}=this;const n=t[e];if(n){return n}const o=Object.keys(t)[0];if(o){return t[o].then((t=>{if(o==="json"){t=JSON.stringify(t)}return new Response(t)[e]()}))}return t[e]=r[e]()};json(){return this.#a("json")}text(){return this.#a("text")}arrayBuffer(){return this.#a("arrayBuffer")}blob(){return this.#a("blob")}formData(){return this.#a("formData")}addValidatedData(e,t){this.#r[e]=t}valid(e){return this.#r[e]}get url(){return this.raw.url}get method(){return this.raw.method}get matchedRoutes(){return this.#n[0].map((([[,e]])=>e))}get routePath(){return this.#n[0].map((([[,e]])=>e))[this.routeIndex].path}};var D={Stringify:1,BeforeStream:2,Stream:3};var raw=(e,t)=>{const r=new String(e);r.isEscaped=true;r.callbacks=t;return r};var P=/[&<>'"]/;var stringBufferToString=async(e,t)=>{let r="";t||=[];const n=await Promise.all(e);for(let e=n.length-1;;e--){r+=n[e];e--;if(e<0){break}let o=n[e];if(typeof o==="object"){t.push(...o.callbacks||[])}const s=o.isEscaped;o=await(typeof o==="object"?o.toString():o);if(typeof o==="object"){t.push(...o.callbacks||[])}if(o.isEscaped??s){r+=o}else{const e=[r];escapeToBuffer(o,e);r=e[0]}}return raw(r,t)};var escapeToBuffer=(e,t)=>{const r=e.search(P);if(r===-1){t[0]+=e;return}let n;let o;let s=0;for(o=r;o<e.length;o++){switch(e.charCodeAt(o)){case 34:n="&quot;";break;case 39:n="&#39;";break;case 38:n="&amp;";break;case 60:n="&lt;";break;case 62:n="&gt;";break;default:continue}t[0]+=e.substring(s,o)+n;s=o+1}t[0]+=e.substring(s,o)};var resolveCallbackSync=e=>{const t=e.callbacks;if(!t?.length){return e}const r=[e];const n={};t.forEach((e=>e({phase:D.Stringify,buffer:r,context:n})));return r[0]};var resolveCallback=async(e,t,r,n,o)=>{if(typeof e==="object"&&!(e instanceof String)){if(!(e instanceof Promise)){e=e.toString()}if(e instanceof Promise){e=await e}}const s=e.callbacks;if(!s?.length){return Promise.resolve(e)}if(o){o[0]+=e}else{o=[e]}const i=Promise.all(s.map((e=>e({phase:t,buffer:o,context:n})))).then((e=>Promise.all(e.filter(Boolean).map((e=>resolveCallback(e,t,false,n,o)))).then((()=>o[0]))));if(r){return raw(await i,s)}else{return i}};var A="text/plain; charset=UTF-8";var setHeaders=(e,t={})=>{for(const r of Object.keys(t)){e.set(r,t[r])}return e};var _=class{#c;#h;env={};#u;finalized=false;error;#l=200;#d;#f;#p;#g;#y=true;#w;#m;#b;#n;#v;constructor(e,t){this.#c=e;if(t){this.#d=t.executionCtx;this.env=t.env;this.#b=t.notFoundHandler;this.#v=t.path;this.#n=t.matchResult}}get req(){this.#h??=new C(this.#c,this.#v,this.#n);return this.#h}get event(){if(this.#d&&"respondWith"in this.#d){return this.#d}else{throw Error("This context has no FetchEvent")}}get executionCtx(){if(this.#d){return this.#d}else{throw Error("This context has no ExecutionContext")}}get res(){this.#y=false;return this.#g||=new Response("404 Not Found",{status:404})}set res(e){this.#y=false;if(this.#g&&e){try{for(const[t,r]of this.#g.headers.entries()){if(t==="content-type"){continue}if(t==="set-cookie"){const t=this.#g.headers.getSetCookie();e.headers.delete("set-cookie");for(const r of t){e.headers.append("set-cookie",r)}}else{e.headers.set(t,r)}}}catch(t){if(t instanceof TypeError&&t.message.includes("immutable")){this.res=new Response(e.body,{headers:e.headers,status:e.status});return}else{throw t}}}this.#g=e;this.finalized=true}render=(...e)=>{this.#m??=e=>this.html(e);return this.#m(...e)};setLayout=e=>this.#w=e;getLayout=()=>this.#w;setRenderer=e=>{this.#m=e};header=(e,t,r)=>{if(t===void 0){if(this.#f){this.#f.delete(e)}else if(this.#p){delete this.#p[e.toLocaleLowerCase()]}if(this.finalized){this.res.headers.delete(e)}return}if(r?.append){if(!this.#f){this.#y=false;this.#f=new Headers(this.#p);this.#p={}}this.#f.append(e,t)}else{if(this.#f){this.#f.set(e,t)}else{this.#p??={};this.#p[e.toLowerCase()]=t}}if(this.finalized){if(r?.append){this.res.headers.append(e,t)}else{this.res.headers.set(e,t)}}};status=e=>{this.#y=false;this.#l=e};set=(e,t)=>{this.#u??=new Map;this.#u.set(e,t)};get=e=>this.#u?this.#u.get(e):void 0;get var(){if(!this.#u){return{}}return Object.fromEntries(this.#u)}#O(e,t,r){if(this.#y&&!r&&!t&&this.#l===200){return new Response(e,{headers:this.#p})}if(t&&typeof t!=="number"){const r=new Headers(t.headers);if(this.#f){this.#f.forEach(((e,t)=>{if(t==="set-cookie"){r.append(t,e)}else{r.set(t,e)}}))}const n=setHeaders(r,this.#p);return new Response(e,{headers:n,status:t.status??this.#l})}const n=typeof t==="number"?t:this.#l;this.#p??={};this.#f??=new Headers;setHeaders(this.#f,this.#p);if(this.#g){this.#g.headers.forEach(((e,t)=>{if(t==="set-cookie"){this.#f?.append(t,e)}else{this.#f?.set(t,e)}}));setHeaders(this.#f,this.#p)}r??={};for(const[e,t]of Object.entries(r)){if(typeof t==="string"){this.#f.set(e,t)}else{this.#f.delete(e);for(const r of t){this.#f.append(e,r)}}}return new Response(e,{status:n,headers:this.#f})}newResponse=(...e)=>this.#O(...e);body=(e,t,r)=>typeof t==="number"?this.#O(e,t,r):this.#O(e,t);text=(e,t,r)=>{if(!this.#p){if(this.#y&&!r&&!t){return new Response(e)}this.#p={}}this.#p["content-type"]=A;if(typeof t==="number"){return this.#O(e,t,r)}return this.#O(e,t)};json=(e,t,r)=>{const n=JSON.stringify(e);this.#p??={};this.#p["content-type"]="application/json";return typeof t==="number"?this.#O(n,t,r):this.#O(n,t)};html=(e,t,r)=>{this.#p??={};this.#p["content-type"]="text/html; charset=UTF-8";if(typeof e==="object"){return resolveCallback(e,D.Stringify,false,{}).then((e=>typeof t==="number"?this.#O(e,t,r):this.#O(e,t)))}return typeof t==="number"?this.#O(e,t,r):this.#O(e,t)};redirect=(e,t)=>{this.#f??=new Headers;this.#f.set("Location",String(e));return this.newResponse(null,t??302)};notFound=()=>{this.#b??=()=>new Response;return this.#b(this)}};var $="ALL";var B="all";var q=["get","post","put","delete","options","patch"];var F="Can not add a route since the matcher is already built.";var W=class extends Error{};var I="__COMPOSED_HANDLER";var notFoundHandler=e=>e.text("404 Not Found",404);var errorHandler=(e,t)=>{if("getResponse"in e){return e.getResponse()}console.error(e);return t.text("Internal Server Error",500)};var U=class{get;post;put;delete;options;patch;all;on;use;router;getPath;_basePath="/";#v="/";routes=[];constructor(e={}){const t=[...q,B];t.forEach((e=>{this[e]=(t,...r)=>{if(typeof t==="string"){this.#v=t}else{this.#E(e,this.#v,t)}r.forEach((t=>{this.#E(e,this.#v,t)}));return this}}));this.on=(e,t,...r)=>{for(const n of[t].flat()){this.#v=n;for(const t of[e].flat()){r.map((e=>{this.#E(t.toUpperCase(),this.#v,e)}))}}return this};this.use=(e,...t)=>{if(typeof e==="string"){this.#v=e}else{this.#v="*";t.unshift(e)}t.forEach((e=>{this.#E($,this.#v,e)}));return this};const{strict:r,...n}=e;Object.assign(this,n);this.getPath=r??true?e.getPath??getPath:getPathNoStrict}#x(){const e=new U({router:this.router,getPath:this.getPath});e.routes=this.routes;return e}#b=notFoundHandler;errorHandler=errorHandler;route(e,t){const r=this.basePath(e);t.routes.map((e=>{let n;if(t.errorHandler===errorHandler){n=e.handler}else{n=async(r,n)=>(await compose([],t.errorHandler)(r,(()=>e.handler(r,n)))).res;n[I]=e.handler}r.#E(e.method,e.path,n)}));return this}basePath(e){const t=this.#x();t._basePath=mergePath(this._basePath,e);return t}onError=e=>{this.errorHandler=e;return this};notFound=e=>{this.#b=e;return this};mount(e,t,r){let n;let o;if(r){if(typeof r==="function"){o=r}else{o=r.optionHandler;n=r.replaceRequest}}const s=o?e=>{const t=o(e);return Array.isArray(t)?t:[t]}:e=>{let t=void 0;try{t=e.executionCtx}catch{}return[e.env,t]};n||=(()=>{const t=mergePath(this._basePath,e);const r=t==="/"?0:t.length;return e=>{const t=new URL(e.url);t.pathname=t.pathname.slice(r)||"/";return new Request(t,e)}})();const handler=async(e,r)=>{const o=await t(n(e.req.raw),...s(e));if(o){return o}await r()};this.#E($,mergePath(e,"*"),handler);return this}#E(e,t,r){e=e.toUpperCase();t=mergePath(this._basePath,t);const n={path:t,method:e,handler:r};this.router.add(e,t,[r,n]);this.routes.push(n)}#R(e,t){if(e instanceof Error){return this.errorHandler(e,t)}throw e}#k(e,t,r,n){if(n==="HEAD"){return(async()=>new Response(null,await this.#k(e,t,r,"GET")))()}const o=this.getPath(e,{env:r});const s=this.router.match(n,o);const i=new _(e,{path:o,matchResult:s,env:r,executionCtx:t,notFoundHandler:this.#b});if(s[0].length===1){let e;try{e=s[0][0][0][0](i,(async()=>{i.res=await this.#b(i)}))}catch(e){return this.#R(e,i)}return e instanceof Promise?e.then((e=>e||(i.finalized?i.res:this.#b(i)))).catch((e=>this.#R(e,i))):e??this.#b(i)}const a=compose(s[0],this.errorHandler,this.#b);return(async()=>{try{const e=await a(i);if(!e.finalized){throw new Error("Context is not finalized. Did you forget to return a Response object or `await next()`?")}return e.res}catch(e){return this.#R(e,i)}})()}fetch=(e,...t)=>this.#k(e,t[1],t[0],e.method);request=(e,t,r,n)=>{if(e instanceof Request){return this.fetch(t?new Request(e,t):e,r,n)}e=e.toString();return this.fetch(new Request(/^https?:\/\//.test(e)?e:`http://localhost${mergePath("/",e)}`,t),r,n)};fire=()=>{addEventListener("fetch",(e=>{e.respondWith(this.#k(e.request,e,void 0,e.request.method))}))}};var M="[^/]+";var K=".*";var V="(?:|/.*)";var L=Symbol();var N=new Set(".\\+*[^]$()");function compareKey(e,t){if(e.length===1){return t.length===1?e<t?-1:1:-1}if(t.length===1){return 1}if(e===K||e===V){return 1}else if(t===K||t===V){return-1}if(e===M){return 1}else if(t===M){return-1}return e.length===t.length?e<t?-1:1:t.length-e.length}var z=class{#T;#S;#j=Object.create(null);insert(e,t,r,n,o){if(e.length===0){if(this.#T!==void 0){throw L}if(o){return}this.#T=t;return}const[s,...i]=e;const a=s==="*"?i.length===0?["","",K]:["","",M]:s==="/*"?["","",V]:s.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);let c;if(a){const e=a[1];let t=a[2]||M;if(e&&a[2]){t=t.replace(/^\((?!\?:)(?=[^)]+\)$)/,"(?:");if(/\((?!\?:)/.test(t)){throw L}}c=this.#j[t];if(!c){if(Object.keys(this.#j).some((e=>e!==K&&e!==V))){throw L}if(o){return}c=this.#j[t]=new z;if(e!==""){c.#S=n.varIndex++}}if(!o&&e!==""){r.push([e,c.#S])}}else{c=this.#j[s];if(!c){if(Object.keys(this.#j).some((e=>e.length>1&&e!==K&&e!==V))){throw L}if(o){return}c=this.#j[s]=new z}}c.insert(i,t,r,n,o)}buildRegExpStr(){const e=Object.keys(this.#j).sort(compareKey);const t=e.map((e=>{const t=this.#j[e];return(typeof t.#S==="number"?`(${e})@${t.#S}`:N.has(e)?`\\${e}`:e)+t.buildRegExpStr()}));if(typeof this.#T==="number"){t.unshift(`#${this.#T}`)}if(t.length===0){return""}if(t.length===1){return t[0]}return"(?:"+t.join("|")+")"}};var G=class{#H={varIndex:0};#C=new z;insert(e,t,r){const n=[];const o=[];for(let t=0;;){let r=false;e=e.replace(/\{[^}]+\}/g,(e=>{const n=`@\\${t}`;o[t]=[n,e];t++;r=true;return n}));if(!r){break}}const s=e.match(/(?::[^\/]+)|(?:\/\*$)|./g)||[];for(let e=o.length-1;e>=0;e--){const[t]=o[e];for(let r=s.length-1;r>=0;r--){if(s[r].indexOf(t)!==-1){s[r]=s[r].replace(t,o[e][1]);break}}}this.#C.insert(s,t,n,this.#H,r);return n}buildRegExp(){let e=this.#C.buildRegExpStr();if(e===""){return[/^$/,[],[]]}let t=0;const r=[];const n=[];e=e.replace(/#(\d+)|@(\d+)|\.\*\$/g,((e,o,s)=>{if(o!==void 0){r[++t]=Number(o);return"$()"}if(s!==void 0){n[Number(s)]=++t;return""}return""}));return[new RegExp(`^${e}`),r,n]}};var X=[];var J=[/^$/,[],Object.create(null)];var Y=Object.create(null);function buildWildcardRegExp(e){return Y[e]??=new RegExp(e==="*"?"":`^${e.replace(/\/\*$|([.\\+*[^\]$()])/g,((e,t)=>t?`\\${t}`:"(?:|/.*)"))}$`)}function clearWildcardRegExpCache(){Y=Object.create(null)}function buildMatcherFromPreprocessedRoutes(e){const t=new G;const r=[];if(e.length===0){return J}const n=e.map((e=>[!/\*|\/:/.test(e[0]),...e])).sort((([e,t],[r,n])=>e?1:r?-1:t.length-n.length));const o=Object.create(null);for(let e=0,s=-1,i=n.length;e<i;e++){const[i,a,c]=n[e];if(i){o[a]=[c.map((([e])=>[e,Object.create(null)])),X]}else{s++}let h;try{h=t.insert(a,s,i)}catch(e){throw e===L?new W(a):e}if(i){continue}r[s]=c.map((([e,t])=>{const r=Object.create(null);t-=1;for(;t>=0;t--){const[e,n]=h[t];r[e]=n}return[e,r]}))}const[s,i,a]=t.buildRegExp();for(let e=0,t=r.length;e<t;e++){for(let t=0,n=r[e].length;t<n;t++){const n=r[e][t]?.[1];if(!n){continue}const o=Object.keys(n);for(let e=0,t=o.length;e<t;e++){n[o[e]]=a[n[o[e]]]}}}const c=[];for(const e in i){c[e]=r[i[e]]}return[s,c,o]}function findMiddleware(e,t){if(!e){return void 0}for(const r of Object.keys(e).sort(((e,t)=>t.length-e.length))){if(buildWildcardRegExp(r).test(t)){return[...e[r]]}}return void 0}var Q=class{name="RegExpRouter";#D;#P;constructor(){this.#D={[$]:Object.create(null)};this.#P={[$]:Object.create(null)}}add(e,t,r){const n=this.#D;const o=this.#P;if(!n||!o){throw new Error(F)}if(!n[e]){[n,o].forEach((t=>{t[e]=Object.create(null);Object.keys(t[$]).forEach((r=>{t[e][r]=[...t[$][r]]}))}))}if(t==="/*"){t="*"}const s=(t.match(/\/:/g)||[]).length;if(/\*$/.test(t)){const i=buildWildcardRegExp(t);if(e===$){Object.keys(n).forEach((e=>{n[e][t]||=findMiddleware(n[e],t)||findMiddleware(n[$],t)||[]}))}else{n[e][t]||=findMiddleware(n[e],t)||findMiddleware(n[$],t)||[]}Object.keys(n).forEach((t=>{if(e===$||e===t){Object.keys(n[t]).forEach((e=>{i.test(e)&&n[t][e].push([r,s])}))}}));Object.keys(o).forEach((t=>{if(e===$||e===t){Object.keys(o[t]).forEach((e=>i.test(e)&&o[t][e].push([r,s])))}}));return}const i=checkOptionalParameter(t)||[t];for(let t=0,a=i.length;t<a;t++){const c=i[t];Object.keys(o).forEach((i=>{if(e===$||e===i){o[i][c]||=[...findMiddleware(n[i],c)||findMiddleware(n[$],c)||[]];o[i][c].push([r,s-a+t+1])}}))}}match(e,t){clearWildcardRegExpCache();const r=this.#A();this.match=(e,t)=>{const n=r[e]||r[$];const o=n[2][t];if(o){return o}const s=t.match(n[0]);if(!s){return[[],X]}const i=s.indexOf("",1);return[n[1][i],s]};return this.match(e,t)}#A(){const e=Object.create(null);Object.keys(this.#P).concat(Object.keys(this.#D)).forEach((t=>{e[t]||=this.#_(t)}));this.#D=this.#P=void 0;return e}#_(e){const t=[];let r=e===$;[this.#D,this.#P].forEach((n=>{const o=n[e]?Object.keys(n[e]).map((t=>[t,n[e][t]])):[];if(o.length!==0){r||=true;t.push(...o)}else if(e!==$){t.push(...Object.keys(n[$]).map((e=>[e,n[$][e]])))}}));if(!r){return null}else{return buildMatcherFromPreprocessedRoutes(t)}}};var Z=class{name="SmartRouter";#$=[];#P=[];constructor(e){this.#$=e.routers}add(e,t,r){if(!this.#P){throw new Error(F)}this.#P.push([e,t,r])}match(e,t){if(!this.#P){throw new Error("Fatal error")}const r=this.#$;const n=this.#P;const o=r.length;let s=0;let i;for(;s<o;s++){const o=r[s];try{for(let e=0,t=n.length;e<t;e++){o.add(...n[e])}i=o.match(e,t)}catch(e){if(e instanceof W){continue}throw e}this.match=o.match.bind(o);this.#$=[o];this.#P=void 0;break}if(s===o){throw new Error("Fatal error")}this.name=`SmartRouter + ${this.activeRouter.name}`;return i}get activeRouter(){if(this.#P||this.#$.length!==1){throw new Error("No active router has been determined yet.")}return this.#$[0]}};var ee=Object.create(null);var te=class{#B;#j;#q;#F=0;#W=ee;constructor(e,t,r){this.#j=r||Object.create(null);this.#B=[];if(e&&t){const r=Object.create(null);r[e]={handler:t,possibleKeys:[],score:0};this.#B=[r]}this.#q=[]}insert(e,t,r){this.#F=++this.#F;let n=this;const o=splitRoutingPath(t);const s=[];for(let e=0,t=o.length;e<t;e++){const t=o[e];const r=o[e+1];const i=getPattern(t,r);const a=Array.isArray(i)?i[0]:t;if(Object.keys(n.#j).includes(a)){n=n.#j[a];const e=getPattern(t,r);if(e){s.push(e[1])}continue}n.#j[a]=new te;if(i){n.#q.push(i);s.push(i[1])}n=n.#j[a]}const i=Object.create(null);const a={handler:r,possibleKeys:s.filter(((e,t,r)=>r.indexOf(e)===t)),score:this.#F};i[e]=a;n.#B.push(i);return n}#I(e,t,r,n){const o=[];for(let s=0,i=e.#B.length;s<i;s++){const i=e.#B[s];const a=i[t]||i[$];const c={};if(a!==void 0){a.params=Object.create(null);o.push(a);if(r!==ee||n&&n!==ee){for(let e=0,t=a.possibleKeys.length;e<t;e++){const t=a.possibleKeys[e];const o=c[a.score];a.params[t]=n?.[t]&&!o?n[t]:r[t]??n?.[t];c[a.score]=true}}}}return o}search(e,t){const r=[];this.#W=ee;const n=this;let o=[n];const s=splitPath(t);const i=[];for(let t=0,n=s.length;t<n;t++){const a=s[t];const c=t===n-1;const h=[];for(let n=0,u=o.length;n<u;n++){const u=o[n];const l=u.#j[a];if(l){l.#W=u.#W;if(c){if(l.#j["*"]){r.push(...this.#I(l.#j["*"],e,u.#W))}r.push(...this.#I(l,e,u.#W))}else{h.push(l)}}for(let n=0,o=u.#q.length;n<o;n++){const o=u.#q[n];const l=u.#W===ee?{}:{...u.#W};if(o==="*"){const t=u.#j["*"];if(t){r.push(...this.#I(t,e,u.#W));t.#W=l;h.push(t)}continue}if(a===""){continue}const[d,f,p]=o;const g=u.#j[d];const y=s.slice(t).join("/");if(p instanceof RegExp){const t=p.exec(y);if(t){l[f]=t[0];r.push(...this.#I(g,e,u.#W,l));if(Object.keys(g.#j).length){g.#W=l;const e=t[0].match(/\//)?.length??0;const r=i[e]||=[];r.push(g)}continue}}if(p===true||p.test(a)){l[f]=a;if(c){r.push(...this.#I(g,e,l,u.#W));if(g.#j["*"]){r.push(...this.#I(g.#j["*"],e,l,u.#W))}}else{g.#W=l;h.push(g)}}}}o=h.concat(i.shift()??[])}if(r.length>1){r.sort(((e,t)=>e.score-t.score))}return[r.map((({handler:e,params:t})=>[e,t]))]}};var re=class{name="TrieRouter";#U;constructor(){this.#U=new te}add(e,t,r){const n=checkOptionalParameter(t);if(n){for(let t=0,o=n.length;t<o;t++){this.#U.insert(e,n[t],r)}return}this.#U.insert(e,t,r)}match(e,t){return this.#U.search(e,t)}};var ne=class extends U{constructor(e={}){super(e);this.router=e.router??new Z({routers:[new Q,new re]})}};var oe=class{writer;encoder;writable;abortSubscribers=[];responseReadable;aborted=false;closed=false;constructor(e,t){this.writable=e;this.writer=e.getWriter();this.encoder=new TextEncoder;const r=t.getReader();this.abortSubscribers.push((async()=>{await r.cancel()}));this.responseReadable=new ReadableStream({async pull(e){const{done:t,value:n}=await r.read();t?e.close():e.enqueue(n)},cancel:()=>{this.abort()}})}async write(e){try{if(typeof e==="string"){e=this.encoder.encode(e)}await this.writer.write(e)}catch{}return this}async writeln(e){await this.write(e+"\n");return this}sleep(e){return new Promise((t=>setTimeout(t,e)))}async close(){try{await this.writer.close()}catch{}this.closed=true}async pipe(e){this.writer.releaseLock();await e.pipeTo(this.writable,{preventClose:true});this.writer=this.writable.getWriter()}onAbort(e){this.abortSubscribers.push(e)}abort(){if(!this.aborted){this.aborted=true;this.abortSubscribers.forEach((e=>e()))}}};var utils_isOldBunVersion=()=>{const e=typeof Bun!=="undefined"?Bun.version:void 0;if(e===void 0){return false}const t=e.startsWith("1.1")||e.startsWith("1.0")||e.startsWith("0.");utils_isOldBunVersion=()=>t;return t};var se=new WeakMap;var stream=(e,t,r)=>{const{readable:n,writable:o}=new TransformStream;const s=new oe(o,n);if(utils_isOldBunVersion()){e.req.raw.signal.addEventListener("abort",(()=>{if(!s.closed){s.abort()}}))}se.set(s.responseReadable,e);(async()=>{try{await t(s)}catch(e){if(e===void 0){}else if(e instanceof Error&&r){await r(e,s)}else{console.error(e)}}finally{s.close()}})();return e.newResponse(s.responseReadable)};var ie=class extends oe{constructor(e,t){super(e,t)}async writeSSE(e){const t=await resolveCallback(e.data,D.Stringify,false,{});const r=t.split("\n").map((e=>`data: ${e}`)).join("\n");const n=[e.event&&`event: ${e.event}`,r,e.id&&`id: ${e.id}`,e.retry&&`retry: ${e.retry}`].filter(Boolean).join("\n")+"\n\n";await this.write(n)}};var run=async(e,t,r)=>{try{await t(e)}catch(t){if(t instanceof Error&&r){await r(t,e);await e.writeSSE({event:"error",data:t.message})}else{console.error(t)}}finally{e.close()}};var ae=new WeakMap;var streamSSE=(e,t,r)=>{const{readable:n,writable:o}=new TransformStream;const s=new ie(o,n);if(isOldBunVersion()){e.req.raw.signal.addEventListener("abort",(()=>{if(!s.closed){s.abort()}}))}ae.set(s.responseReadable,e);e.header("Transfer-Encoding","chunked");e.header("Content-Type","text/event-stream");e.header("Cache-Control","no-cache");e.header("Connection","keep-alive");run(s,t,r);return e.newResponse(s.responseReadable)};var streamText=(e,t,r)=>{e.header("Content-Type",A);e.header("X-Content-Type-Options","nosniff");e.header("Transfer-Encoding","chunked");return stream(e,t,r)};const ce=require("node:child_process");const he=require("node:crypto");var ue=__nccwpck_require__(882);var le=undefined&&undefined.__awaiter||function(e,t,r,n){function adopt(e){return e instanceof r?e:new r((function(t){t(e)}))}return new(r||(r=Promise))((function(r,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n["throw"](e))}catch(e){o(e)}}function step(e){e.done?r(e.value):adopt(e.value).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())}))};var de,fe;const pe=(fe=(de=process.env["ALLOWED_EXECUTABLES"])===null||de===void 0?void 0:de.split(","))!==null&&fe!==void 0?fe:[];const ge=Number(process.env["TIMEOUT"])||1e4;const ye=process.env["SECRET"];const we=new Set;const me=(new ne).get("/health",(e=>le(void 0,void 0,void 0,(function*(){return e.text("OK")})))).get("/auth/:code?",(e=>le(void 0,void 0,void 0,(function*(){const{code:t}=e.req.param();if(!ye||!t){const t=ue.authenticator.generateSecret();return e.text(t)}if(!ue.authenticator.check(ye,t)){return e.text("Invalid code",403)}const r=(0,he.randomUUID)();we.add(r);setTimeout((()=>we.delete(r)),18e5);return e.text(r)})))).get("/:exec/*",(e=>le(void 0,void 0,void 0,(function*(){try{const{exec:t}=e.req.param();if(!pe.includes(t)){return e.text("Not allowed",403)}const r=e.req.url.split("/").slice(4).map((e=>decodeURIComponent(e)));const{stdout:n,stderr:o,token:s}=e.req.query();if(s&&!we.has(s)){return e.text("Invalid token",403)}return streamText(e,(e=>new Promise(((s,i)=>{const a=(0,ce.spawn)(t,r,{env:process.env});const c=setTimeout((()=>{e.abort()}),ge);a.on("close",(()=>{clearTimeout(c);s()}));a.on("error",(()=>{clearTimeout(c);i()}));let h=Promise.resolve();const handler=t=>{h=new Promise((r=>le(void 0,void 0,void 0,(function*(){yield h;e.write(t.toString()).finally(r)}))))};(n!==undefined||n===o)&&a.stdout.on("data",handler);(o!==undefined||n===o)&&a.stderr.on("data",handler)}))),((e,t)=>le(void 0,void 0,void 0,(function*(){yield t.write(String(e));t.abort()}))))}catch(t){return e.text(t.message,500)}}))));const be=Number(process.env["PORT"])||3e3;serve({fetch:me.fetch.bind(me),port:be});
//# sourceMappingURL=index.js.map