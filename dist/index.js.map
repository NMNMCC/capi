{"version":3,"file":"index.js","names":["__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","exports","module","threw","__webpack_modules__","__awaiter","thisArg","_arguments","P","generator","adopt","value","resolve","Promise","reject","fulfilled","step","next","e","rejected","result","done","then","apply","_a","_b","ALLOWED_EXECUTABLES","process","env","split","TIMEOUT","Number","SECRET","tokens","Set","server","hono_Hono","get","ctx","text","code","req","param","secret","otplib","authenticator","generateSecret","check","token","external_node_crypto_namespaceObject","randomUUID","add","setTimeout","delete","exec","includes","args","url","slice","map","arg","decodeURIComponent","stdout","stderr","query","has","streamText","stream","child","external_node_child_process_namespaceObject","spawn","timeout","abort","on","clearTimeout","last","handler","data","write","toString","finally","err","String","message","port","serve","fetch","bind"],"sources":["../webpack/bootstrap","../src/index.ts"],"sourcesContent":["// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\tvar threw = true;\n\ttry {\n\t\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\t\tthrew = false;\n\t} finally {\n\t\tif(threw) delete __webpack_module_cache__[moduleId];\n\t}\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar _a, _b;\nimport { serve } from \"@hono/node-server\";\nimport { Hono } from \"hono\";\nimport { streamText } from \"hono/streaming\";\nimport { spawn } from \"node:child_process\";\nimport { randomUUID } from \"node:crypto\";\nimport { authenticator } from \"otplib\";\nconst ALLOWED_EXECUTABLES = (_b = (_a = process.env[\"ALLOWED_EXECUTABLES\"]) === null || _a === void 0 ? void 0 : _a.split(\",\")) !== null && _b !== void 0 ? _b : [];\nconst TIMEOUT = Number(process.env[\"TIMEOUT\"]) || 10000;\nconst SECRET = process.env[\"SECRET\"];\nconst tokens = new Set();\nconst server = new Hono()\n    .get(\"/health\", (ctx) => __awaiter(void 0, void 0, void 0, function* () { return ctx.text(\"OK\"); }))\n    .get(\"/auth/:code?\", (ctx) => __awaiter(void 0, void 0, void 0, function* () {\n    const { code } = ctx.req.param();\n    if (!SECRET || !code) {\n        const secret = authenticator.generateSecret();\n        return ctx.text(secret);\n    }\n    if (!authenticator.check(SECRET, code)) {\n        return ctx.text(\"Invalid code\", 403);\n    }\n    const token = randomUUID();\n    tokens.add(token);\n    setTimeout(() => tokens.delete(token), 1800000);\n    return ctx.text(token);\n}))\n    .get(\"/:exec/*\", (ctx) => __awaiter(void 0, void 0, void 0, function* () {\n    try {\n        const { exec } = ctx.req.param();\n        if (!ALLOWED_EXECUTABLES.includes(exec)) {\n            return ctx.text(\"Not allowed\", 403);\n        }\n        const args = ctx.req.url\n            .split(\"/\")\n            .slice(4)\n            .map((arg) => decodeURIComponent(arg));\n        const { stdout, stderr, token } = ctx.req.query();\n        if (token && !tokens.has(token)) {\n            return ctx.text(\"Invalid token\", 403);\n        }\n        return streamText(ctx, (stream) => new Promise((resolve, reject) => {\n            const child = spawn(exec, args, {\n                env: process.env,\n            });\n            const timeout = setTimeout(() => {\n                stream.abort();\n            }, TIMEOUT);\n            child.on(\"close\", () => {\n                clearTimeout(timeout);\n                resolve();\n            });\n            child.on(\"error\", () => {\n                clearTimeout(timeout);\n                reject();\n            });\n            let last = Promise.resolve();\n            const handler = (data) => {\n                last = new Promise((resolve) => __awaiter(void 0, void 0, void 0, function* () {\n                    yield last;\n                    stream.write(data.toString()).finally(resolve);\n                }));\n            };\n            (stdout !== undefined || stdout === stderr) &&\n                child.stdout.on(\"data\", handler);\n            (stderr !== undefined || stdout === stderr) &&\n                child.stderr.on(\"data\", handler);\n        }), (err, stream) => __awaiter(void 0, void 0, void 0, function* () {\n            yield stream.write(String(err));\n            stream.abort();\n        }));\n    }\n    catch (e) {\n        return ctx.text(e.message, 500);\n    }\n}));\nconst port = Number(process.env[\"PORT\"]) || 3000;\nserve({\n    fetch: server.fetch.bind(server),\n    port: port,\n});\n"],"mappings":"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","ignoreList":[]}